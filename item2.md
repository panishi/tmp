---
marp: true
transition: "slide"
slideNumber: true
---
<!-- theme: gaia -->
<!-- size: 16:9 -->
<!-- page_number: true -->
<!-- paginate: true -->

<style>
img[alt~="center"] {
  display: block;
  margin: 0 auto;
}
</style>

# Effective C++
Item 2: `#define` より，`const`，`enum`，`inline` を使おう

2021/7/21

---
### はじめに
- このItemのタイトルは，言い換えれば「プリプロセッサよりコンパイラを使おう」ということ．
- プリプロセッサは「狭い意味のコンパイラ」よりも先に使われるものと考えられる．

---
### `#define` による定数の問題点1
- 次のようなコードを考える．
```cpp
#define ASPECT_RATIO 1.653
```
- `ASPECT_RATIO` はコンパイラからは見えないかもしれないが，コンパイラが処理する前の段階で，ソース中の `ASPECT_RATIO` が数値 (1.653) に置き換えられる．
- 結果，`ASPECT_RATIO` はコンパイラが持つシンボル表に登録されないことになる．

---
### `#define` による定数の問題点2
- コンパイル中にエラーが出た場合，エラーメッセージには `ASPECT_RATIO` ではなく1.653という値が直接使われてしまう．
- `ASPECT_RATIO` が他人が書いたヘッダファイル内で定義されていた場合，1.653がどこから来たか全く分からなくなってしまう．
- 「シンボル表に登録されない」ということは，シンボリック・デバッガを使っても同じことになる．

---
### マクロを定数に置き換える
- 上記の問題は，マクロを定数に置き換えることで解決される．
```cpp
const double AspectRatio = 1.653;
```
- `AspectRatio` は，言語で規定された定数となり，コンパイラから見え，そのシンボル表に登録されることになる．
- `AspectRatio` の値は必ず1箇所に置かれるので，`#define` によるものよりコードが小さくなるかもしれない．

---
### 定数ポインタについて
- 定数は，一般にはヘッダファイル内に置かれるので，`const` を付けておくことが重要．
- これは定数ポインタについても同様 (Item 3を参照)．
```cpp
const char* const authorName = "Scott Meyers";
```

---
### クラスの持つ定数について1
- クラスで使う定数のスコープを限定するため，定数をクラスの `static` メンバにすることがある．
```cpp
class GamePlayer
{
    static const int NumTurns = 5;  // 定数宣言
    int scores[NumTurns];           // 定数の使用
    …
};
```

---
### クラスの持つ定数について2
- 上記は `NumTurns` の宣言であって，定義ではない．
- ただし，`static` な整数型の「クラスの定数」は，宣言をすれば定義をしなくても使えるようになっている．
- クラスの定数のアドレスを使うような場合，定義を別途cppファイル側に書くことになる．
```cpp
const int GamePlayer::NumTurns;
```
- 宣言の場所で初期化 (ここでは5) されているので，定義の場所で初期値を与えることは出来ない．

---
### クラスの持つ定数について3
- `#define` にはスコープという考え方が無いので，「クラスの定数」を作ることは出来ず，カプセル化にも使えない．
- `const` 宣言した変数ならば，`NumTurns` のように，クラスの中に置いて `private` メンバにすることが出来る．

---
### 古いコンパイラの場合
- 古いコンパイラの場合は，「`static` な整数型定数メンバ」の宣言時初期化に対応しておらず，コンパイル出来ないことがある．
- 「宣言時の初期化」という構文が使えない場合，初期値は定義の場所に書くことになる．
```cpp
class CostEstimate
{
    static const double FudgeFactor;            // staticなクラス定数の宣言
    …
};

const double CostEstimate::FudgeFactor = 1.35;  // staticなクラス定数の定義
                                                // これはソースファイルに書かれる
```

---
### `enum` ハック1
- コンパイル時に「クラスの定数」が必要になった場合（配列のサイズ等），問題が起こる．
- コンパイラが「クラスの定数」の初期化を宣言時に行うことを拒否した場合，親しみを込めて「`enum` ハック」と呼ばれる方法が広く行われている．
- これは，`enum` 型の値が `int` としても使えることを利用するテクニック．

---
### `enum` ハック2
```cpp
class GamePlayer
{
    enum { NumTurns = 5 };  // 「enumハック」
                            // NumTurnsを5の代わりに使えるようにする
    int scores[NumTurns];   // 問題無し
    …
};
```

---
### `enum` ハック3
- `enum` ハックは，`const` より `#define` に近い．
- `const` な変数のアドレスを使うことは出来るが，`enum` 要素や `#define` で定義した名前のアドレスを使うことは許されていない．
- コンパイラが整数型定数オブジェクトのメモリ確保を (プログラマの意図に反して) 行ってしまうことを防ぐためにも，`enum` ハックを使うことが出来る．

---
### `#define` による関数の問題点1
- `#define` を使って定義するマクロは，関数のように働くが関数呼び出しのオーバーヘッドが無い．
```cpp
// a, bの大きい方を使ってfを呼び出す
#define CALL_WITH_MAX(a, b) f((a) > (b) ? (a) : (b))
```
- このマクロは，数多くの問題を含んでいる．

---
### `#define` による関数の問題点2
- このようなマクロを書く時には，仮引数を丸括弧で囲むことを忘れてはいけない．
- 正しく丸括弧を付けても問題は起き得て，以下の例では `f` が呼び出される前に `a` が何回インクリメントされるかが引数の値によって変わってしまう！
```cpp
int a = 5, b = 0;
CALL_WITH_MAX(++a, b);       // aが2回インクリメントされる
CALL_WITH_MAX(++a, b + 10);  // aが1回インクリメントされる
```

---
### インライン関数の使用1
- インライン関数のテンプレートを作れば，マクロのように効率的で，振る舞いが明白かつ型安全なインライン関数が得られる (Item 30を参照)．
```cpp
// Tの型が分からないため参照仮引数を使う (Item 20を参照)
template<typnename T>
inline void callWithMax(const T& a, const T& b)
{
    return f(a > b ? a : b)
}
```

---
### インライン関数の使用2
- 関数テンプレートの中で，仮引数を丸括弧で囲む必要は無いし，引数が複数回評価されることを心配する必要も無い．
- `callWithMax` は関数なので，通常のスコープとアクセスのルールに従う．

---
### おわりに
- `const`，`enum`，`inline` を使えば，プリプロセッサ (特に `#define`) の必要性は小さくなる．
- プリプロセッサの必要性が全く無くなる訳では無く，`#include` は必須だし，`#ifdef` / `#ifndef` は未だにコンパイル時の制御で重要な役割を果たしている．
- プリプロセッサの引退はまだ先の話だが，長期休暇を頻繁に出してあげても良いかもしれない✈️

---
### Things to Remember
- 単純な定数には，`#define` より，`const` か `enum` を使うようにしよう．
- `#define` で定義するマクロより，インライン関数を使うようにしよう．
